{% extends "orga/base.html" %}
{% load bootstrap4 %}
{% load i18n %}
{% load review_score %}
{% load rules %}
{% load url_replace %}

{% block content %}
{% has_perm 'orga.perform_reviews' request.user request.event as can_review %}
{% has_perm 'orga.view_all_reviews' request.user request.event as can_view_all_reviews %}
{% has_perm 'orga.view_speakers' request.user request.event as can_view_speakers %}
<div class="alert alert-info">
    {% if can_review and next_submission %}
        <a href="{{ next_submission.orga_urls.reviews }}">
        {{ missing_reviews|length }}
        {% blocktrans trimmed count count=missing_reviews|length %}
        submission is waiting for your review.
        {% plural %}
        submissions are waiting for your review.
        {% endblocktrans %}
        {% trans "Click here to get started!" %}
        </a>
    {% elif can_review %}
        {% trans "You've got no submissions left to review!" %}
    {% else %}
        {% trans "Reviews are currently closed." %}
    {% endif %}
</div>

<div class="submit-group">
    <form class="search-form">
        {% bootstrap_form search_form %}
        {% bootstrap_field filter_form.submission_type %}
        {% bootstrap_field filter_form.state layout='inline' %}
        {% if request.event.settings.use_tracks %}
            {% bootstrap_field filter_form.track %}
        {% endif %}
        <button class="btn btn-success" type="submit">{% trans "Search" %}</button>
    </form>
</div>

<table class="table table-sm review-table table-hover table-responsive-md">
    <colgroup>
        <col class="nowrap">
        <col class="nowrap">
        <col class="w-75">
        {% if can_view_speakers %}<col class="w-25">{% endif %}
        <col class="nowrap">
        <col class="nowrap">
        <col class="nowrap">
    </colgroup>
    <thead>
        <tr>
            <th>
                {% if can_view_all_reviews %}
                    {% trans "Average score" %}
                {% else %}
                    {% trans "Score" %}
                {% endif %}
                <a href="?{% url_replace request 'sort' 'score' %}"><i class="fa fa-caret-down"></i></a>
                <a href="?{% url_replace request 'sort' '-score' %}"><i class="fa fa-caret-up"></i></a>
            </th>
            <th>
                {% trans "Reviews" %}
                <a href="?{% url_replace request 'sort' '-count' %}"><i class="fa fa-caret-down"></i></a>
                <a href="?{% url_replace request 'sort' 'count' %}"><i class="fa fa-caret-up"></i></a>
            </th>
            <th>{% trans "Title" %}</th>
            {% if can_view_speakers %}<th>{% trans "Speakers" %}</th>{% endif %}
            <th>{% trans "Type" %}</th>
            <th>{% trans "State" %}</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
    {% for submission in submissions %}
        {% has_perm 'submission.accept_submission' request.user submission as can_accept_submission %}
        {% has_perm 'submission.reject_submission' request.user submission as can_reject_submission %}
        <tr class="{{ submission.state }}">
            <td>
                {% review_score submission %}
            </td>
            <td>
                {{ submission.reviews.all|length|default:'-' }}
                {% if can_view_all_reviews %}
                    {% if submission.pk in submissions_reviewed %}
                        <i class="fa fa-check text-success" title="{% trans "You have reviewed this submission" %}"></i>
                    {% endif %}
                {% endif %}
            </td>
            <td>
                <a href="{% if can_review %}{{ submission.orga_urls.reviews }}{% else %}{{ submission.orga_urls.base }}{% endif %}">
                    {{ submission.title }}
                </a>
            </td>
            {% if can_view_speakers %}<td>{{ submission.display_speaker_names }}</td>{% endif %}
            <td>{{ submission.submission_type.name }}</td>
            <td class="nowrap">
                {% include "cfp/event/fragment_state.html" with state=submission.state %}
            </td>
            <td class="action-row d-flex">
                {% if submission.state == 'submitted' %}
                    {% if can_accept_submission %}
                        <a class="btn btn-success btn-sm" href="{{ submission.orga_urls.accept }}?next={{ request.path }}%3F{{ request.META.QUERY_STRING|urlencode }}">{% trans "Accept" %}</a>
                    {% endif %}
                    {% if can_reject_submission %}
                        <a class="btn btn-danger btn-sm" href="{{ submission.orga_urls.reject }}?next={{ request.path }}%3F{{ request.META.QUERY_STRING|urlencode }}">{% trans "Reject" %}</a>
                    {% endif %}
                {% endif %}
            </td>
        </tr>
    {% empty %}
        <tr>
            <td>{% trans "You don't seem to have any submissions yet." %}</td>
        </tr>
    {% endfor %}
    </tbody>
</table>
{% endblock %}
